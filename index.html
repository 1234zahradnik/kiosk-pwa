<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kiosk → n8n</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root { --bg:#0b1220; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#0ea5e9; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); }
    header { padding:16px 20px; background:linear-gradient(90deg,#0ea5e9 0%,#22d3ee 100%); color:#001018; font-weight:700; letter-spacing:.3px; }
    main { max-width:800px; margin:0 auto; padding:20px; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,.35); }
    label { display:block; margin:12px 0 6px; color:var(--muted); font-size:14px; }
    input, select, textarea { width:100%; padding:12px 14px; border-radius:12px; border:1px solid #374151; background:#0a0f1a; color:var(--ink); outline:none; }
    textarea { min-height:100px; resize:vertical; }
    .row { display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:640px){ .row2 { grid-template-columns:1fr 1fr; } }
    .btn { width:100%; background:var(--accent); color:#041318; border:none; margin-top:16px; padding:14px 16px; font-weight:800; border-radius:14px; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #1f2937; background:#0a0f1a; font-size:12px; }
    .ok { color:#10b981; } .warn { color:#f59e0b; } .err { color:#ef4444; }
    .status { margin-top:10px; font-size:14px; }
    .grid-2 { display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    .small { font-size:12px; } footer { text-align:center; color:var(--muted); font-size:12px; padding:20px 10px; }
  </style>
</head>
<body>
  <header>Kiosk → n8n</header>
  <main>
    <div class="card">
      <p class="small">This form captures GPS (with permission) and posts JSON to your n8n webhook.</p>

      <div class="grid-2 small">
        <div>GPS: <span id="gpsStatus" class="pill">requesting…</span></div>
        <div>Installable: <span id="installStatus" class="pill">checking…</span></div>
      </div>

      <form id="kioskForm">
        <div class="row row2">
          <div>
            <label for="who">Your name</label>
            <input id="who" name="who" autocomplete="name" placeholder="e.g., Miles" required />
          </div>
          <div>
            <label for="contact">Contact (optional)</label>
            <input id="contact" name="contact" autocomplete="tel" placeholder="phone/email" />
          </div>
        </div>

        <!-- NEW: address to notify -->
        <label for="notify">Send to (email)</label>
        <input id="notify" name="notify" placeholder="e.g., wife@example.com" />

        <label for="summary">Summary / What happened?</label>
        <textarea id="summary" name="summary" placeholder="Short description…" required></textarea>

        <label for="photo">Photo (optional)</label>
        <input id="photo" name="photo" type="file" accept="image/*" capture="environment" />

        <div class="row row2">
          <div>
            <label for="site">Site / Line (optional)</label>
            <input id="site" name="site" placeholder="e.g., Line 2 / Press 4" />
          </div>
          <div>
            <label>Location (auto)</label>
            <div class="small" id="locationPreview">Waiting for GPS…</div>
          </div>
        </div>

        <button class="btn" type="submit">Submit to n8n</button>
        <div id="status" class="status"></div>
      </form>
    </div>

    <footer><div>Add to Home Screen for kiosk mode. Works offline; retries when back online.</div></footer>
  </main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const gpsEl = $("#gpsStatus");
  const locPreview = $("#locationPreview");
  const statusEl = $("#status");

  // ✅ Your production webhook URL
  const webhookUrl = "https://n8n.srv966244.hstgr.cloud/webhook/kiosk-intake-separate";

  let coords = null;

  // PWA install state
  const installEl = $("#installStatus");
  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); installEl.textContent = "ready to install"; });
  window.addEventListener('appinstalled', () => { installEl.textContent = "installed"; });
  installEl.textContent = window.matchMedia('(display-mode: standalone)').matches ? "installed" : "available";

  // Service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  }

  // GPS
  function onGPSOk(position){
    coords = {
      lat: position.coords.latitude,
      lng: position.coords.longitude,
      accuracy_m: position.coords.accuracy ?? null,
      ts: new Date().toISOString()
    };
    const mapLink = `https://maps.google.com/?q=${coords.lat},${coords.lng}`;
    gpsEl.textContent = "ok"; gpsEl.classList.add("ok");
    locPreview.innerHTML = `<a href="${mapLink}" target="_blank" rel="noopener">Open in Google Maps</a><br/><span class="small">± ${Math.round(coords.accuracy_m || 0)} m</span>`;
  }
  function onGPSErr(){
    gpsEl.textContent = "disabled"; gpsEl.classList.add("warn");
    locPreview.textContent = "Location permission denied or unavailable.";
  }
  try {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(onGPSOk, onGPSErr, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    } else {
      gpsEl.textContent = "no GPS"; gpsEl.classList.add("err");
      locPreview.textContent = "Geolocation not supported.";
    }
  } catch { gpsEl.textContent = "error"; gpsEl.classList.add("err"); }

  // File → base64
  function fileToDataURL(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // Submit
  $("#kioskForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.textContent = "Submitting…";

    const form = e.target;
    const who = form.who.value.trim();
    const contact = form.contact.value.trim();
    const notify = form.notify.value.trim();            // <-- NEW
    const summary = form.summary.value.trim();
    const site = form.site.value.trim();
    const photo = form.photo.files[0];

    let photo_b64 = null;
    if (photo) {
      try { photo_b64 = await fileToDataURL(photo); } catch {}
    }

    const payload = {
      who, contact, summary, site, notify,                 // <-- NEW in payload
      device: navigator.userAgent,
      submitted_at: new Date().toISOString(),
      coords,
      maps_link: coords ? `https://maps.google.com/?q=${coords.lat},${coords.lng}` : null,
      photo_b64
    };

    // Queue locally for offline retry
    try {
      const q = JSON.parse(localStorage.getItem("pendingSubmissions") || "[]");
      q.push(payload);
      localStorage.setItem("pendingSubmissions", JSON.stringify(q));
    } catch {}

    async function postOnce(body){
      const resp = await fetch(webhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      return resp;
    }

    try {
      await postOnce(payload);
      statusEl.innerHTML = "<span class='ok'>Submitted.</span>";
      const q = JSON.parse(localStorage.getItem("pendingSubmissions") || "[]"); q.pop();
      localStorage.setItem("pendingSubmissions", JSON.stringify(q));
      form.reset();
      locPreview.textContent = coords ? ("Saved GPS: " + coords.lat.toFixed(5) + ", " + coords.lng.toFixed(5)) : "No GPS";
    } catch {
      statusEl.innerHTML = "<span class='warn'>Offline or webhook failed. Will retry when online.</span>";
      if ('serviceWorker' in navigator && navigator.serviceWorker.ready) {
        try { (await navigator.serviceWorker.ready).sync.register('sync-submissions'); } catch {}
      }
    }
  });
})();
</script>
</body>
</html>
